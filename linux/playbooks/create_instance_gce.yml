- name: "Create instance from image in Google Compute Engine"
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: "Ensure state of virtual instance in google compute engine"
      gce:
        name:           "{{ gce_name              | default(mandatory)        }}"
        zone:           "{{ gce_zone              | default('europe-west1-d') }}"
        machine_type:   "{{ gce_machine_type      | default('n1-standard-1')  }}"
        image:          "{{ gce_image             | default('rhel-7')         }}"
        disk_size:      "{{ gce_disk_size_gb      | default('20')             }}"
        tags:           "{{ gce_machine_tags      | default('staging')        }}"
        num_instances:  "{{ gce_num_instances     | default(omit)             }}"
        state:          "{{ gce_state }}"
      register:         r_gce
      with_items:
        - present
        - started
      loop_control:
        loop_var:       gce_state
        label:          "{{ gce_state }}"

    - name: "Ensure application tags for instance"
      gce_tag:
        instance_pattern: "{{ gce_name  }}*"
        zone:             "{{ gce_zone              | default('europe-west1-d') }}"
        tags:             "{{ gce_application_tags  | default('unknown') }}"
        state:            "present"
